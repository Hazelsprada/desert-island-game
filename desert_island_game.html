<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desert Island Survival Simulation</title>
    <style>
        /* ========================================
           GLOBAL STYLES
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========================================
           CARD STYLES
        ======================================== */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        p {
            color: #718096;
            margin-bottom: 15px;
        }

        /* ========================================
           BUTTON STYLES
        ======================================== */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-block {
            width: 100%;
            margin-top: 10px;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* ========================================
           SELECTION GRID STYLES
        ======================================== */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .selection-item {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
        }

        .selection-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .selection-item.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .selection-item h4 {
            color: #2d3748;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .selection-item p {
            color: #718096;
            font-size: 0.85rem;
            margin: 0;
        }

        /* ========================================
           STRATEGIC CHOICE STYLES
        ======================================== */
        .choice-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .choice-card {
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .choice-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .choice-card h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .choice-card .effects {
            font-size: 0.9rem;
            color: #48bb78;
            margin-top: 8px;
        }

        .choice-card .tradeoffs {
            font-size: 0.9rem;
            color: #f56565;
            margin-top: 5px;
        }

        /* ========================================
           STATUS COUNTER
        ======================================== */
        .status-counter {
            background: #edf2f7;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        /* ========================================
           FACILITATOR DASHBOARD STYLES
        ======================================== */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .team-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .team-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
        }

        .team-status {
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-waiting {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-complete {
            background: #bee3f8;
            color: #2c5282;
        }

        /* ========================================
           STATUS BAR STYLES
        ======================================== */
        .status-bars {
            margin: 15px 0;
        }

        .status-bar-item {
            margin-bottom: 12px;
        }

        .status-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .status-bar-container {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .status-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }

        /* Color coding for status bars */
        .bar-health { background: #48bb78; }
        .bar-morale { background: #4299e1; }
        .bar-food { background: #ed8936; }
        .bar-shelter { background: #9f7aea; }
        .bar-rescue { background: #f56565; }

        /* ========================================
           TEAM INFO SECTIONS
        ======================================== */
        .team-selections {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .selection-section {
            margin-bottom: 10px;
        }

        .selection-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .selection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: #edf2f7;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #2d3748;
        }

        /* ========================================
           RESULTS STYLES
        ======================================== */
        .results-summary {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .outcome-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .outcome-rescued {
            background: #c6f6d5;
            color: #22543d;
        }

        .outcome-surviving {
            background: #feebc8;
            color: #7c2d12;
        }

        .outcome-struggling {
            background: #fed7d7;
            color: #742a2a;
        }

        .explanation {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
        }

        .explanation h4 {
            color: #2d3748;
            margin-bottom: 8px;
        }

        .explanation p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        /* ========================================
           UTILITY CLASSES
        ======================================== */
        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .alert-warning {
            background: #feebc8;
            color: #7c2d12;
            border-left: 4px solid #ed8936;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            .selection-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .teams-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>

    <!-- ========================================
         TEAM INPUT PAGE (Mobile-Friendly)
    ======================================== -->
    <div id="teamPage" class="container">
        <!-- Team Setup Screen -->
        <div id="setupScreen" class="card">
            <h1>üèùÔ∏è Desert Island Survival</h1>
            <p>Welcome to the leadership simulation. Enter your team name to begin.</p>
            
            <input type="text" id="teamNameInput" placeholder="Enter team name" 
                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem; margin-bottom: 15px;">
            
            <button class="btn btn-primary btn-block" onclick="startTeamSession()">Start Session</button>
            <button class="btn btn-secondary btn-block" onclick="switchToFacilitator()">Facilitator Dashboard</button>
        </div>

        <!-- Round 1: Role Selection -->
        <div id="roleSelectionScreen" class="card hidden">
            <h2>Round 1: Select Your Team Roles</h2>
            <div class="status-counter">
                <span id="roleCounter">Select 5 roles (0/5 selected)</span>
            </div>
            
            <div class="selection-grid" id="roleGrid"></div>
            
            <button class="btn btn-primary btn-block" id="rolesConfirmBtn" onclick="confirmRoles()" disabled>
                Confirm Roles
            </button>
        </div>

        <!-- Round 1: Resource Selection -->
        <div id="resourceSelectionScreen" class="card hidden">
            <h2>Round 1: Select Your Resources</h2>
            <div class="status-counter">
                <span id="resourceCounter">Select 4 resources (0/4 selected)</span>
            </div>
            
            <div class="selection-grid" id="resourceGrid"></div>
            
            <button class="btn btn-primary btn-block" id="resourcesConfirmBtn" onclick="confirmResources()" disabled>
                Confirm Resources
            </button>
        </div>

        <!-- Round 1: Event Display -->
        <div id="eventScreen" class="card hidden">
            <h2>Round 1: Survival Event</h2>
            <div id="eventContent"></div>
            
            <button class="btn btn-primary btn-block" onclick="proceedToRound2()">
                Continue to Round 2
            </button>
        </div>

        <!-- Round 2: Strategic Choice -->
        <div id="strategicChoiceScreen" class="card hidden">
            <h2>Round 2: Strategic Decision</h2>
            <p>Your team must choose one strategic focus for the next phase of survival.</p>
            
            <div class="choice-grid" id="choiceGrid"></div>
            
            <button class="btn btn-primary btn-block" id="choiceConfirmBtn" onclick="confirmChoice()" disabled>
                Confirm Strategic Choice
            </button>
        </div>

        <!-- Final Results -->
        <div id="resultsScreen" class="card hidden">
            <h2>Final Outcome</h2>
            <div id="resultsContent"></div>
            
            <button class="btn btn-secondary btn-block" onclick="resetGame()">
                Start New Session
            </button>
        </div>
    </div>

    <!-- ========================================
         FACILITATOR DASHBOARD (Monitor Display)
    ======================================== -->
    <div id="facilitatorPage" class="dashboard-container hidden">
        <div class="dashboard-header">
            <h1>üèùÔ∏è Facilitator Dashboard - Desert Island Survival</h1>
            <p>Monitor all teams in real-time. This view updates automatically.</p>
            <button class="btn btn-primary" onclick="switchToTeam()">Switch to Team View</button>
            <button class="btn btn-secondary" onclick="resetAllTeams()" style="margin-left: 10px;">Reset All Teams</button>
        </div>

        <div id="teamsDisplay" class="teams-grid">
            <div class="card text-center">
                <p style="color: #718096;">No teams have started yet. Teams will appear here once they begin their sessions.</p>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GAME CONFIGURATION DATA
        // ========================================

        // Available roles with descriptions and impact modifiers
        const ROLES = {
            medic: {
                name: "Medic",
                description: "Treats injuries and illness",
                impact: { health: 0.5, morale: 0.1 }
            },
            engineer: {
                name: "Engineer",
                description: "Designs and builds structures",
                impact: { shelter: 0.4, resourceEffectiveness: 0.2 }
            },
            strategist: {
                name: "Strategist",
                description: "Plans and coordinates",
                impact: { decisionQuality: 0.3, rescue: 0.1 }
            },
            builder: {
                name: "Builder",
                description: "Constructs and repairs",
                impact: { shelter: 0.5, construction: 0.3 }
            },
            forager: {
                name: "Forager",
                description: "Finds food and water",
                impact: { food: 0.4, health: 0.1 }
            },
            navigator: {
                name: "Navigator",
                description: "Finds paths and signals",
                impact: { rescue: 0.3, exploration: 0.2 }
            },
            communicator: {
                name: "Communicator",
                description: "Maintains team cohesion",
                impact: { morale: 0.4, coordination: 0.2 }
            }
        };

        // Available resources with benefits
        const RESOURCES = {
            waterPurifier: {
                name: "Water Purifier",
                description: "Clean water source",
                impact: { health: 15, food: 10 },
                synergy: ["medic", "forager"]
            },
            emergencyRations: {
                name: "Emergency Rations",
                description: "Immediate food supply",
                impact: { food: 25 },
                synergy: []
            },
            radio: {
                name: "Radio",
                description: "Communication device",
                impact: { rescue: 20 },
                synergy: ["navigator", "communicator"]
            },
            rope: {
                name: "Rope",
                description: "Versatile tool",
                impact: { shelter: 15 },
                synergy: ["builder", "engineer"]
            },
            tarp: {
                name: "Tarp",
                description: "Weather protection",
                impact: { shelter: 20 },
                synergy: ["builder"]
            },
            multitool: {
                name: "Multitool",
                description: "Universal utility",
                impact: { resourceEffectiveness: 0.2 },
                synergy: ["engineer", "builder", "forager"]
            },
            seeds: {
                name: "Seeds",
                description: "Long-term food source",
                impact: { food: 15 },
                synergy: ["forager"]
            }
        };

        // Round 1 survival events
        const EVENTS = [
            {
                name: "Severe Storm",
                description: "A powerful storm hits the island with heavy rain and wind.",
                impact: { shelter: -20, health: -15, morale: -10 },
                mitigation: {
                    roles: { builder: 0.4, engineer: 0.4 },
                    resources: { tarp: 0.3, rope: 0.3 }
                }
            },
            {
                name: "Team Member Injury",
                description: "A team member suffers a significant injury requiring immediate care.",
                impact: { health: -25, morale: -15, food: -10 },
                mitigation: {
                    roles: { medic: 0.5 },
                    resources: { waterPurifier: 0.2 }
                }
            },
            {
                name: "Food Contamination",
                description: "Your food supply becomes contaminated, creating a health crisis.",
                impact: { food: -30, health: -20, morale: -15 },
                mitigation: {
                    roles: { forager: 0.4 },
                    resources: { waterPurifier: 0.35, emergencyRations: 0.3 }
                }
            },
            {
                name: "Extreme Heatwave",
                description: "Dangerous temperatures strain resources and team endurance.",
                impact: { health: -20, morale: -25, food: -15 },
                mitigation: {
                    roles: { builder: 0.2 },
                    resources: { tarp: 0.3, waterPurifier: 0.4 }
                }
            }
        ];

        // Round 2 strategic choices
        const STRATEGIC_CHOICES = {
            stabilize: {
                name: "Stabilize Survival",
                description: "Focus on maintaining current status and minimizing risk.",
                effects: "Moderate improvements to health, food, and shelter",
                tradeoffs: "Reduced rescue probability",
                impact: { health: 15, food: 12, shelter: 15, rescue: -10 }
            },
            rescue: {
                name: "Pursue Rescue",
                description: "Maximize efforts toward signaling and rescue.",
                effects: "Major boost to rescue probability",
                tradeoffs: "Diverted resources reduce food and shelter",
                impact: { rescue: 30, food: -15, shelter: -10 }
            },
            longterm: {
                name: "Long-term Sustainability",
                description: "Build infrastructure for extended survival.",
                effects: "Significant improvements to food, shelter, and health",
                tradeoffs: "Reduced rescue focus and team morale",
                impact: { food: 20, shelter: 15, health: 10, rescue: -20, morale: -10 }
            }
        };

        // Round 2 opportunity/risk windows
        const ROUND2_SCENARIOS = [
            {
                name: "Passing Aircraft",
                description: "A plane is spotted flying overhead - a narrow window for signaling.",
                successCondition: (team) => team.status.rescue > 60 || (team.resources.includes("radio") && team.roles.includes("navigator")),
                successImpact: { rescue: 50 },
                failureImpact: { morale: -15 },
                successText: "Your team successfully signals the aircraft!",
                failureText: "The aircraft passes without noticing your signals."
            },
            {
                name: "Radio Signal Window",
                description: "A brief radio frequency window opens for potential communication.",
                successCondition: (team) => team.resources.includes("radio") && (team.roles.includes("communicator") || team.roles.includes("navigator")),
                successImpact: { rescue: 40 },
                failureImpact: { rescue: -10 },
                successText: "Your team makes contact through the radio!",
                failureText: "Unable to establish communication - energy wasted."
            },
            {
                name: "Internal Conflict",
                description: "Tensions rise within the team, threatening cohesion.",
                successCondition: (team) => team.roles.includes("communicator") || team.status.morale > 60,
                successImpact: { morale: 10 },
                failureImpact: { morale: -20, health: -10, food: -10, shelter: -10, rescue: -10 },
                successText: "Your team resolves the conflict constructively.",
                failureText: "The conflict damages team cohesion and effectiveness."
            },
            {
                name: "Environmental Degradation",
                description: "The island's natural resources show signs of depletion.",
                successCondition: (team) => team.status.food > 70 || team.roles.includes("forager"),
                successImpact: { food: 5, health: 5 },
                failureImpact: { food: -20, health: -15 },
                successText: "Your team adapts to the changing environment.",
                failureText: "Resource depletion creates a survival crisis."
            }
        ];

        // ========================================
        // GAME STATE MANAGEMENT
        // ========================================

        let currentTeam = null;
        let gameState = {
            teamName: "",
            roles: [],
            resources: [],
            status: {
                health: 80,
                morale: 70,
                food: 60,
                shelter: 50,
                rescue: 30
            },
            round1Event: null,
            round2Choice: null,
            round2Scenario: null,
            completed: false
        };

        // ========================================
        // INITIALIZATION & PAGE SWITCHING
        // ========================================

        // Initialize the game on page load
        window.onload = function() {
            loadAllTeams();
            // Start on team input page
            document.getElementById("teamPage").classList.remove("hidden");
            document.getElementById("facilitatorPage").classList.add("hidden");
        };

        function switchToFacilitator() {
            document.getElementById("teamPage").classList.add("hidden");
            document.getElementById("facilitatorPage").classList.remove("hidden");
            updateDashboard();
            // Auto-refresh dashboard every 3 seconds
            setInterval(updateDashboard, 3000);
        }

        function switchToTeam() {
            document.getElementById("facilitatorPage").classList.add("hidden");
            document.getElementById("teamPage").classList.remove("hidden");
        }

        // ========================================
        // TEAM SESSION MANAGEMENT
        // ========================================

        function startTeamSession() {
            const teamName = document.getElementById("teamNameInput").value.trim();
            
            if (!teamName) {
                alert("Please enter a team name");
                return;
            }

            // Initialize new game state
            currentTeam = teamName;
            gameState = {
                teamName: teamName,
                roles: [],
                resources: [],
                status: {
                    health: 80,
                    morale: 70,
                    food: 60,
                    shelter: 50,
                    rescue: 30
                },
                round1Event: null,
                round2Choice: null,
                round2Scenario: null,
                completed: false,
                timestamp: new Date().toISOString()
            };

            saveTeamData();

            // Hide setup, show role selection
            document.getElementById("setupScreen").classList.add("hidden");
            document.getElementById("roleSelectionScreen").classList.remove("hidden");

            renderRoleSelection();
        }

        // ========================================
        // ROUND 1: ROLE SELECTION
        // ========================================

        function renderRoleSelection() {
            const grid = document.getElementById("roleGrid");
            grid.innerHTML = "";

            Object.keys(ROLES).forEach(roleKey => {
                const role = ROLES[roleKey];
                const div = document.createElement("div");
                div.className = "selection-item";
                div.onclick = () => toggleRole(roleKey, div);
                
                div.innerHTML = `
                    <h4>${role.name}</h4>
                    <p>${role.description}</p>
                `;
                
                grid.appendChild(div);
            });
        }

        function toggleRole(roleKey, element) {
            const index = gameState.roles.indexOf(roleKey);
            
            if (index > -1) {
                // Deselect
                gameState.roles.splice(index, 1);
                element.classList.remove("selected");
            } else {
                // Select if under limit
                if (gameState.roles.length < 5) {
                    gameState.roles.push(roleKey);
                    element.classList.add("selected");
                } else {
                    alert("You can only select 5 roles");
                    return;
                }
            }

            // Update counter and button state
            document.getElementById("roleCounter").textContent = 
                `Select 5 roles (${gameState.roles.length}/5 selected)`;
            document.getElementById("rolesConfirmBtn").disabled = gameState.roles.length !== 5;
        }

        function confirmRoles() {
            saveTeamData();
            
            // Hide role selection, show resource selection
            document.getElementById("roleSelectionScreen").classList.add("hidden");
            document.getElementById("resourceSelectionScreen").classList.remove("hidden");
            
            renderResourceSelection();
        }

        // ========================================
        // ROUND 1: RESOURCE SELECTION
        // ========================================

        function renderResourceSelection() {
            const grid = document.getElementById("resourceGrid");
            grid.innerHTML = "";

            Object.keys(RESOURCES).forEach(resourceKey => {
                const resource = RESOURCES[resourceKey];
                const div = document.createElement("div");
                div.className = "selection-item";
                div.onclick = () => toggleResource(resourceKey, div);
                
                div.innerHTML = `
                    <h4>${resource.name}</h4>
                    <p>${resource.description}</p>
                `;
                
                grid.appendChild(div);
            });
        }

        function toggleResource(resourceKey, element) {
            const index = gameState.resources.indexOf(resourceKey);
            
            if (index > -1) {
                // Deselect
                gameState.resources.splice(index, 1);
                element.classList.remove("selected");
            } else {
                // Select if under limit
                if (gameState.resources.length < 4) {
                    gameState.resources.push(resourceKey);
                    element.classList.add("selected");
                } else {
                    alert("You can only select 4 resources");
                    return;
                }
            }

            // Update counter and button state
            document.getElementById("resourceCounter").textContent = 
                `Select 4 resources (${gameState.resources.length}/4 selected)`;
            document.getElementById("resourcesConfirmBtn").disabled = gameState.resources.length !== 4;
        }

        function confirmResources() {
            // Apply resource bonuses
            applyResourceBonuses();
            
            // Select random event
            gameState.round1Event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            
            // Apply event with mitigation
            applyEvent();
            
            saveTeamData();
            
            // Hide resource selection, show event
            document.getElementById("resourceSelectionScreen").classList.add("hidden");
            document.getElementById("eventScreen").classList.remove("hidden");
            
            renderEvent();
        }

        // ========================================
        // ROUND 1: EVENT PROCESSING
        // ========================================

        function applyResourceBonuses() {
            // Apply immediate resource benefits
            gameState.resources.forEach(resourceKey => {
                const resource = RESOURCES[resourceKey];
                Object.keys(resource.impact).forEach(stat => {
                    if (gameState.status[stat] !== undefined) {
                        gameState.status[stat] += resource.impact[stat];
                    }
                });
            });
        }

        function applyEvent() {
            const event = gameState.round1Event;
            
            // Calculate mitigation factor
            let mitigation = 0;
            
            // Check role mitigation
            gameState.roles.forEach(roleKey => {
                if (event.mitigation.roles[roleKey]) {
                    mitigation += event.mitigation.roles[roleKey];
                }
            });
            
            // Check resource mitigation
            gameState.resources.forEach(resourceKey => {
                if (event.mitigation.resources[resourceKey]) {
                    mitigation += event.mitigation.resources[resourceKey];
                }
            });
            
            // Cap mitigation at 70% (no complete elimination)
            mitigation = Math.min(mitigation, 0.7);
            
            // Apply mitigated damage
            Object.keys(event.impact).forEach(stat => {
                const damage = event.impact[stat];
                const mitigatedDamage = damage * (1 - mitigation);
                gameState.status[stat] += mitigatedDamage;
                
                // Ensure stats stay within 0-100 range
                gameState.status[stat] = Math.max(0, Math.min(100, gameState.status[stat]));
            });
        }

        function renderEvent() {
            const event = gameState.round1Event;
            const content = document.getElementById("eventContent");
            
            let html = `
                <div class="alert alert-warning">
                    <h3>‚ö†Ô∏è ${event.name}</h3>
                    <p>${event.description}</p>
                </div>
                
                <h3>Impact on Team Status:</h3>
                <div class="status-bars">
            `;
            
            // Show all status bars
            Object.keys(gameState.status).forEach(stat => {
                const value = Math.round(gameState.status[stat]);
                const label = stat.charAt(0).toUpperCase() + stat.slice(1);
                html += `
                    <div class="status-bar-item">
                        <div class="status-bar-label">
                            <span>${label}</span>
                            <span>${value}%</span>
                        </div>
                        <div class="status-bar-container">
                            <div class="status-bar-fill bar-${stat}" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            content.innerHTML = html;
        }

        function proceedToRound2() {
            document.getElementById("eventScreen").classList.add("hidden");
            document.getElementById("strategicChoiceScreen").classList.remove("hidden");
            
            renderStrategicChoices();
        }

        // ========================================
        // ROUND 2: STRATEGIC CHOICE
        // ========================================

        function renderStrategicChoices() {
            const grid = document.getElementById("choiceGrid");
            grid.innerHTML = "";

            Object.keys(STRATEGIC_CHOICES).forEach(choiceKey => {
                const choice = STRATEGIC_CHOICES[choiceKey];
                const div = document.createElement("div");
                div.className = "choice-card";
                div.onclick = () => selectChoice(choiceKey, div);
                
                div.innerHTML = `
                    <h4>${choice.name}</h4>
                    <p>${choice.description}</p>
                    <div class="effects">‚úì ${choice.effects}</div>
                    <div class="tradeoffs">‚úó ${choice.tradeoffs}</div>
                `;
                
                grid.appendChild(div);
            });
        }

        function selectChoice(choiceKey, element) {
            // Clear previous selection
            document.querySelectorAll(".choice-card").forEach(card => {
                card.classList.remove("selected");
            });
            
            // Select new choice
            element.classList.add("selected");
            gameState.round2Choice = choiceKey;
            
            // Enable confirm button
            document.getElementById("choiceConfirmBtn").disabled = false;
        }

        function confirmChoice() {
            // Apply strategic choice impact
            const choice = STRATEGIC_CHOICES[gameState.round2Choice];
            Object.keys(choice.impact).forEach(stat => {
                gameState.status[stat] += choice.impact[stat];
                gameState.status[stat] = Math.max(0, Math.min(100, gameState.status[stat]));
            });
            
            // Select random Round 2 scenario
            gameState.round2Scenario = ROUND2_SCENARIOS[Math.floor(Math.random() * ROUND2_SCENARIOS.length)];
            
            // Apply scenario outcome
            applyRound2Scenario();
            
            // Mark as completed
            gameState.completed = true;
            
            saveTeamData();
            
            // Show results
            document.getElementById("strategicChoiceScreen").classList.add("hidden");
            document.getElementById("resultsScreen").classList.remove("hidden");
            
            renderResults();
        }

        // ========================================
        // ROUND 2: SCENARIO PROCESSING
        // ========================================

        function applyRound2Scenario() {
            const scenario = gameState.round2Scenario;
            const success = scenario.successCondition(gameState);
            
            scenario.success = success;
            
            const impact = success ? scenario.successImpact : scenario.failureImpact;
            
            Object.keys(impact).forEach(stat => {
                gameState.status[stat] += impact[stat];
                gameState.status[stat] = Math.max(0, Math.min(100, gameState.status[stat]));
            });
        }

        // ========================================
        // FINAL RESULTS
        // ========================================

        function renderResults() {
            const content = document.getElementById("resultsContent");
            const scenario = gameState.round2Scenario;
            const choice = STRATEGIC_CHOICES[gameState.round2Choice];
            
            // Determine outcome category
            let outcome = "struggling";
            let outcomeText = "Struggling";
            let outcomeClass = "outcome-struggling";
            
            if (gameState.status.rescue >= 80) {
                outcome = "rescued";
                outcomeText = "Successfully Rescued";
                outcomeClass = "outcome-rescued";
            } else if (gameState.status.health >= 60 && gameState.status.food >= 60 && gameState.status.shelter >= 60) {
                outcome = "surviving";
                outcomeText = "Surviving Sustainably";
                outcomeClass = "outcome-surviving";
            }
            
            let html = `
                <div class="outcome-badge ${outcomeClass}">${outcomeText}</div>
                
                <div class="alert ${scenario.success ? 'alert-info' : 'alert-danger'}">
                    <h3>${scenario.name}</h3>
                    <p>${scenario.description}</p>
                    <p><strong>${scenario.success ? scenario.successText : scenario.failureText}</strong></p>
                </div>
                
                <h3>Final Team Status:</h3>
                <div class="status-bars">
            `;
            
            // Show final status bars
            Object.keys(gameState.status).forEach(stat => {
                const value = Math.round(gameState.status[stat]);
                const label = stat.charAt(0).toUpperCase() + stat.slice(1);
                html += `
                    <div class="status-bar-item">
                        <div class="status-bar-label">
                            <span>${label}</span>
                            <span>${value}%</span>
                        </div>
                        <div class="status-bar-container">
                            <div class="status-bar-fill bar-${stat}" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            });
            
            // Generate explanation
            html += `
                </div>
                
                <div class="explanation">
                    <h4>What Led to This Outcome:</h4>
            `;
            
            // Analyze key decisions
            if (outcome === "rescued") {
                html += `<p><strong>Rescue Success:</strong> Your team's focus on ${choice.name.toLowerCase()} 
                         combined with ${scenario.success ? 'effective' : 'your'} response to ${scenario.name.toLowerCase()} 
                         resulted in a successful rescue operation.</p>`;
            } else if (outcome === "surviving") {
                html += `<p><strong>Sustainable Survival:</strong> While rescue wasn't achieved, your team established 
                         a viable long-term survival situation through ${choice.name.toLowerCase()} and maintaining 
                         critical resources.</p>`;
            } else {
                html += `<p><strong>Survival Challenges:</strong> Your team faces significant difficulties. 
                         The combination of ${gameState.round1Event.name.toLowerCase()}, your strategic choice of 
                         ${choice.name.toLowerCase()}, and the ${scenario.success ? 'partial' : 'failed'} response to 
                         ${scenario.name.toLowerCase()} has depleted critical resources.</p>`;
            }
            
            // Role and resource analysis
            const strongAreas = [];
            const weakAreas = [];
            
            if (gameState.status.health >= 70) strongAreas.push("health");
            else if (gameState.status.health < 50) weakAreas.push("health");
            
            if (gameState.status.morale >= 70) strongAreas.push("morale");
            else if (gameState.status.morale < 50) weakAreas.push("morale");
            
            if (gameState.status.food >= 70) strongAreas.push("food");
            else if (gameState.status.food < 50) weakAreas.push("food");
            
            if (strongAreas.length > 0) {
                html += `<p><strong>Strengths:</strong> Your team maintained strong ${strongAreas.join(", ")} 
                         through effective use of your selected roles and resources.</p>`;
            }
            
            if (weakAreas.length > 0) {
                html += `<p><strong>Vulnerabilities:</strong> Critical challenges in ${weakAreas.join(", ")} 
                         required more resources or different strategic choices to address effectively.</p>`;
            }
            
            html += `</div>`;
            
            content.innerHTML = html;
        }

        // ========================================
        // FACILITATOR DASHBOARD
        // ========================================

        function updateDashboard() {
            const teams = loadAllTeams();
            const container = document.getElementById("teamsDisplay");
            
            if (teams.length === 0) {
                container.innerHTML = `
                    <div class="card text-center">
                        <p style="color: #718096;">No teams have started yet. Teams will appear here once they begin their sessions.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = "";
            
            teams.forEach(team => {
                const card = createTeamCard(team);
                container.appendChild(card);
            });
        }

        function createTeamCard(team) {
            const div = document.createElement("div");
            div.className = "team-card";
            
            // Determine team status
            let status = "active";
            let statusText = "In Progress";
            
            if (team.completed) {
                status = "complete";
                statusText = "Completed";
            } else if (!team.roles || team.roles.length === 0) {
                status = "waiting";
                statusText = "Setting Up";
            }
            
            let html = `
                <div class="team-header">
                    <div class="team-name">${team.teamName}</div>
                    <div class="team-status status-${status}">${statusText}</div>
                </div>
            `;
            
            if (team.roles && team.roles.length > 0) {
                // Show status bars
                html += `<div class="status-bars">`;
                
                Object.keys(team.status).forEach(stat => {
                    const value = Math.round(team.status[stat]);
                    const label = stat.charAt(0).toUpperCase() + stat.slice(1);
                    html += `
                        <div class="status-bar-item">
                            <div class="status-bar-label">
                                <span>${label}</span>
                                <span>${value}%</span>
                            </div>
                            <div class="status-bar-container">
                                <div class="status-bar-fill bar-${stat}" style="width: ${value}%"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Show selections
                html += `<div class="team-selections">`;
                
                if (team.roles && team.roles.length > 0) {
                    html += `
                        <div class="selection-section">
                            <div class="selection-label">Roles</div>
                            <div class="selection-tags">
                    `;
                    team.roles.forEach(roleKey => {
                        html += `<span class="tag">${ROLES[roleKey].name}</span>`;
                    });
                    html += `</div></div>`;
                }
                
                if (team.resources && team.resources.length > 0) {
                    html += `
                        <div class="selection-section">
                            <div class="selection-label">Resources</div>
                            <div class="selection-tags">
                    `;
                    team.resources.forEach(resourceKey => {
                        html += `<span class="tag">${RESOURCES[resourceKey].name}</span>`;
                    });
                    html += `</div></div>`;
                }
                
                if (team.round2Choice) {
                    html += `
                        <div class="selection-section">
                            <div class="selection-label">Strategic Choice</div>
                            <div class="selection-tags">
                                <span class="tag">${STRATEGIC_CHOICES[team.round2Choice].name}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            div.innerHTML = html;
            return div;
        }

        // ========================================
        // LOCAL STORAGE MANAGEMENT
        // ========================================

        function saveTeamData() {
            const teams = loadAllTeams();
            
            // Find and update existing team or add new
            const index = teams.findIndex(t => t.teamName === gameState.teamName);
            if (index > -1) {
                teams[index] = {...gameState};
            } else {
                teams.push({...gameState});
            }
            
            localStorage.setItem("desertIslandTeams", JSON.stringify(teams));
        }

        function loadAllTeams() {
            const data = localStorage.getItem("desertIslandTeams");
            return data ? JSON.parse(data) : [];
        }

        function resetGame() {
            currentTeam = null;
            gameState = {
                teamName: "",
                roles: [],
                resources: [],
                status: {
                    health: 80,
                    morale: 70,
                    food: 60,
                    shelter: 50,
                    rescue: 30
                },
                round1Event: null,
                round2Choice: null,
                round2Scenario: null,
                completed: false
            };
            
            // Reset UI
            document.getElementById("resultsScreen").classList.add("hidden");
            document.getElementById("setupScreen").classList.remove("hidden");
            document.getElementById("teamNameInput").value = "";
        }

        function resetAllTeams() {
            if (confirm("Are you sure you want to reset all team data? This cannot be undone.")) {
                localStorage.removeItem("desertIslandTeams");
                updateDashboard();
            }
        }

    </script>
</body>
</html>