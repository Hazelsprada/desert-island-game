<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desert Island Survival Simulation</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Island decoration */
        .island-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 48px;
            line-height: 1;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .round-indicator {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* ==================== SELECTION GRID ==================== */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .selection-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .selection-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .selection-item.selected {
            background: #667eea;
            border-color: #5568d3;
            color: white;
        }

        .selection-item .item-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .selection-item .item-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .selection-item .item-desc {
            font-size: 11px;
            opacity: 0.8;
        }

        .selection-count {
            background: #ffc107;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* ==================== EVENT DISPLAY ==================== */
        .event-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .event-box.danger {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .event-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .event-box.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .event-title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 10px;
            color: #856404;
        }

        .event-box.danger .event-title {
            color: #721c24;
        }

        .event-box.success .event-title {
            color: #155724;
        }

        .event-box.info .event-title {
            color: #0c5460;
        }

        /* ==================== STATUS BARS ==================== */
        .status-display {
            margin: 20px 0;
        }

        .status-item {
            margin-bottom: 15px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-bar {
            width: 100%;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .status-bar-fill {
            height: 100%;
            transition: width 0.5s ease, background 0.3s;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-health { background: #28a745; }
        .status-morale { background: #17a2b8; }
        .status-food { background: #ffc107; }
        .status-shelter { background: #fd7e14; }
        .status-rescue { background: #dc3545; }

        /* ==================== STRATEGY SELECTION ==================== */
        .strategy-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .strategy-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .strategy-item.selected {
            background: #667eea;
            border-color: #5568d3;
            color: white;
        }

        .strategy-item .strategy-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .strategy-item .strategy-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ==================== FACILITATOR DASHBOARD ==================== */
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .team-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .team-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .team-status.waiting {
            background: #ffc107;
            color: #856404;
        }

        .team-status.playing {
            background: #28a745;
            color: white;
        }

        .team-status.complete {
            background: #6c757d;
            color: white;
        }

        .team-choices {
            font-size: 12px;
            color: #6c757d;
            margin: 10px 0;
            line-height: 1.6;
        }

        .outcome-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .outcome-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .selection-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <!-- ==================== PASSWORD PROTECTION ==================== -->
    <div id="passwordScreen" class="container" style="max-width: 400px;">
        <div class="island-header">üèùÔ∏è</div>
        <h1 class="text-center">Access Required</h1>
        <p class="subtitle text-center">Enter the workshop password to continue</p>
        
        <input type="password" id="passwordInput" placeholder="Enter password" 
               style="width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
        
        <button class="btn" onclick="checkPassword()">Access Game</button>
        
        <p id="passwordError" style="color: #dc3545; margin-top: 10px; font-size: 14px; text-align: center; display: none;">
            Incorrect password. Please try again.
        </p>
    </div>

    <!-- ==================== TEAM INPUT PAGE ==================== -->
    <div id="teamPage" class="container hidden">
        <div class="island-header">üèùÔ∏èüåäüå¥</div>
        <h1>Desert Island Survival</h1>
        <p class="subtitle">Leadership Workshop Simulation</p>

        <!-- Team Name Input -->
        <div id="setupScreen">
            <h2>Team Setup</h2>
            <input type="text" id="teamNameInput" placeholder="Enter your team name" 
                   style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
            <button class="btn" onclick="startGame()">Join Lobby</button>
            <button class="btn btn-secondary" onclick="showDashboard()">Open Facilitator Dashboard</button>
        </div>

        <!-- Lobby/Waiting Screen -->
        <div id="lobbyScreen" class="hidden">
            <h2>‚è≥ Waiting for Facilitator</h2>
            <div class="event-box info">
                <div class="event-title">Team Ready</div>
                <p>Your team is in the lobby. Waiting for the facilitator to start the game...</p>
                <p style="margin-top: 15px; font-size: 13px;">All teams will begin simultaneously when the facilitator clicks "Start All Teams" on the dashboard.</p>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <div style="font-size: 48px; animation: pulse 2s infinite;">‚è≥</div>
            </div>
        </div>

        <!-- Round 1: Role Selection -->
        <div id="roleSelection" class="hidden">
            <h2><span class="round-indicator">Round 1</span> Select Your Team Roles</h2>
            <div class="selection-count">Selected: <span id="roleCount">0</span> / 4</div>
            <div class="selection-grid" id="roleGrid"></div>
            <button class="btn" onclick="completeRoleSelection()" id="roleBtn" disabled>Confirm Roles</button>
        </div>

        <!-- Round 1: Resource Selection -->
        <div id="resourceSelection" class="hidden">
            <h2><span class="round-indicator">Round 1</span> Select Your Resources</h2>
            <div class="selection-count">Selected: <span id="resourceCount">0</span> / 4</div>
            <div class="selection-grid" id="resourceGrid"></div>
            <button class="btn" onclick="completeResourceSelection()" id="resourceBtn" disabled>Confirm Resources</button>
        </div>

        <!-- Round 1: Event -->
        <div id="eventScreen" class="hidden">
            <h2><span class="round-indicator">Round 1</span> Survival Event</h2>
            <div id="eventContent" class="event-box danger"></div>
            <div class="status-display" id="round1Status"></div>
            <button class="btn" onclick="showRound(2)">Continue to Round 2</button>
        </div>

        <!-- Round 2: Strategic Choice -->
        <div id="round2Screen" class="hidden">
            <h2><span class="round-indicator">Round 2</span> Strategic Decision</h2>
            <p class="subtitle">Choose your team's strategic focus for this round.</p>
            <div id="round2StrategyGrid"></div>
            <button class="btn" onclick="completeRound(2)" id="round2Btn" disabled>Confirm Strategy</button>
        </div>

        <!-- Round 2: Outcome -->
        <div id="round2Outcome" class="hidden">
            <h2><span class="round-indicator">Round 2</span> Outcome</h2>
            <div id="round2Content" class="event-box"></div>
            <div class="status-display" id="round2Status"></div>
            <button class="btn" onclick="showRound(3)">Continue to Round 3</button>
        </div>

        <!-- Round 3: Strategic Choice -->
        <div id="round3Screen" class="hidden">
            <h2><span class="round-indicator">Round 3</span> Strategic Decision</h2>
            <p class="subtitle">Another critical decision point. Choose your approach.</p>
            <div id="round3StrategyGrid"></div>
            <button class="btn" onclick="completeRound(3)" id="round3Btn" disabled>Confirm Strategy</button>
        </div>

        <!-- Round 3: Outcome -->
        <div id="round3Outcome" class="hidden">
            <h2><span class="round-indicator">Round 3</span> Outcome</h2>
            <div id="round3Content" class="event-box"></div>
            <div class="status-display" id="round3Status"></div>
            <button class="btn" onclick="showRound(4)">Continue to Round 4</button>
        </div>

        <!-- Round 4: Strategic Choice -->
        <div id="round4Screen" class="hidden">
            <h2><span class="round-indicator">Round 4</span> Final Strategic Decision</h2>
            <p class="subtitle">This is your last major decision. Make it count.</p>
            <div id="round4StrategyGrid"></div>
            <button class="btn" onclick="completeRound(4)" id="round4Btn" disabled>Confirm Strategy</button>
        </div>

        <!-- Round 4: Outcome -->
        <div id="round4Outcome" class="hidden">
            <h2><span class="round-indicator">Round 4</span> Final Outcome</h2>
            <div id="round4Content" class="event-box"></div>
            <div class="status-display" id="round4Status"></div>
            <button class="btn" onclick="showFinalResults()">View Final Results</button>
        </div>

        <!-- Final Results -->
        <div id="resultsScreen" class="hidden">
            <div class="island-header">üèùÔ∏è</div>
            <h2>Final Results</h2>
            <div id="resultsContent"></div>
            <div id="resultsStatus" class="status-display"></div>
            <button class="btn btn-secondary" onclick="resetGame()">Start New Game</button>
        </div>
    </div>

    <!-- ==================== FACILITATOR DASHBOARD ==================== -->
    <div id="dashboardPage" class="container dashboard hidden">
        <div class="island-header">üéØüìä</div>
        <h1 class="text-center">Facilitator Dashboard</h1>
        <p class="subtitle text-center">Real-time monitoring of all team simulations</p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="hideDashboard()">Back to Team Input</button>
            <button class="btn" onclick="startAllTeams()" id="startAllBtn" style="background: #28a745;">üöÄ Start All Teams</button>
            <button class="btn btn-secondary" onclick="clearAllData()" style="background: #dc3545; margin-left: auto;">Clear All Data</button>
        </div>
        
        <div id="sessionStatus" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600;">
            ‚è∏Ô∏è Game Not Started - Teams in Lobby: <span id="lobbyCount">0</span>
        </div>
        
        <div id="teamsDisplay" class="teams-grid"></div>
    </div>

    <script>
        // ==================== PASSWORD PROTECTION ====================
        
        /**
         * Password configuration
         * Change this password to whatever you want for your workshop
         */
        const WORKSHOP_PASSWORD = "PFG";
        
        /**
         * Check password and grant access
         * Stores authentication in sessionStorage so it persists during browser session
         */
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            
            if (input === WORKSHOP_PASSWORD) {
                sessionStorage.setItem('desertIslandAuth', 'true');
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('teamPage').classList.remove('hidden');
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        /**
         * Check authentication on page load
         */
        window.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = sessionStorage.getItem('desertIslandAuth') === 'true';
            
            if (isAuthenticated) {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('teamPage').classList.remove('hidden');
            } else {
                document.getElementById('passwordInput').focus();
            }
            
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });
        
        // ==================== GAME DATA STRUCTURES ====================
        
        /**
         * Available roles with REDUCED bonuses
         */
        const ROLES = [
            { id: 'medic', name: 'Medic', icon: '‚öïÔ∏è', desc: 'Healthcare expertise', mitigates: ['injury', 'heatwave', 'aggressive_animals', 'medical_crisis'], bonus: { health: 8 } },
            { id: 'engineer', name: 'Engineer', icon: 'üîß', desc: 'Technical skills', mitigates: ['storm', 'severe_weather'], bonus: { shelter: 12 } },
            { id: 'strategist', name: 'Strategist', icon: 'üéØ', desc: 'Decision analysis', mitigates: ['internal_conflict'], bonus: { rescue: 5, morale: 5 } },
            { id: 'builder', name: 'Builder', icon: 'üî®', desc: 'Construction skills', mitigates: ['storm', 'heatwave', 'severe_weather'], bonus: { shelter: 12 } },
            { id: 'forager', name: 'Forager', icon: 'üåø', desc: 'Food gathering', mitigates: ['food_contamination', 'environmental_degradation'], bonus: { food: 12 } },
            { id: 'navigator', name: 'Navigator', icon: 'üß≠', desc: 'Orientation expert', mitigates: ['passing_aircraft'], bonus: { rescue: 8 } },
            { id: 'communicator', name: 'Communicator', icon: 'üì°', desc: 'Team coordination', mitigates: ['internal_conflict', 'radio_signal'], bonus: { morale: 12 } },
            { id: 'celebrity', name: 'Celebrity', icon: '‚≠ê', desc: 'High visibility', mitigates: ['passing_aircraft'], bonus: { morale: 8, rescue: 5 } }
        ];

        /**
         * Available resources with REDUCED bonuses
         */
        const RESOURCES = [
            { id: 'water_purifier', name: 'Water Purifier', icon: 'üíß', desc: 'Clean water', mitigates: ['food_contamination', 'heatwave', 'injury', 'medical_crisis'], bonus: { health: 8 } },
            { id: 'rations', name: 'Emergency Rations', icon: 'ü•´', desc: 'Food reserves', mitigates: ['food_contamination'], bonus: { food: 15 } },
            { id: 'handbook', name: 'Boy Scout Handbook', icon: 'üìñ', desc: 'Survival guide', mitigates: ['storm', 'aggressive_animals', 'environmental_degradation', 'severe_weather'], bonus: { shelter: 4, food: 4, health: 4 } },
            { id: 'rope', name: 'Rope', icon: 'ü™¢', desc: 'Versatile tool', mitigates: ['storm', 'severe_weather'], bonus: { shelter: 8 } },
            { id: 'tarp', name: 'Tarp', icon: 'üèïÔ∏è', desc: 'Weather protection', mitigates: ['storm', 'heatwave', 'severe_weather'], bonus: { shelter: 12 } },
            { id: 'multitool', name: 'Multitool', icon: 'üî™', desc: 'Universal utility', mitigates: [], bonus: { health: 4, shelter: 4, food: 4 } },
            { id: 'seeds', name: 'Seeds', icon: 'üå±', desc: 'Agriculture', mitigates: ['environmental_degradation'], bonus: { food: 8 } },
            { id: 'matches', name: 'Matches', icon: 'üî•', desc: 'Fire starting', mitigates: ['heatwave', 'aggressive_animals'], bonus: { morale: 8, health: 4 } }
        ];

        /**
         * Round 1 survival events - MORE PUNISHING
         */
        const EVENTS = [
            { 
                id: 'storm', 
                name: '‚õàÔ∏è Severe Storm', 
                desc: 'A violent storm strikes the island, threatening your shelter and supplies.',
                impact: { shelter: -30, health: -20, morale: -15, food: -10 }
            },
            { 
                id: 'injury', 
                name: 'ü©π Team Member Injury', 
                desc: 'A team member suffers a serious injury requiring immediate attention.',
                impact: { health: -35, morale: -20, food: -15, shelter: -10 }
            },
            { 
                id: 'food_contamination', 
                name: 'ü¶† Food Contamination', 
                desc: 'Your food supply shows signs of contamination and spoilage.',
                impact: { food: -40, health: -25, morale: -20 }
            },
            { 
                id: 'heatwave', 
                name: 'üå°Ô∏è Extreme Heatwave', 
                desc: 'Oppressive heat threatens dehydration and exhaustion.',
                impact: { health: -30, morale: -30, food: -20, shelter: -10 }
            },
            { 
                id: 'aggressive_animals', 
                name: 'üêó Aggressive Animals', 
                desc: 'Wild animals threaten your camp and food supplies.',
                impact: { health: -25, food: -25, shelter: -20, morale: -15 }
            }
        ];

        /**
         * Strategic choices with HARSH TRADE-OFFS
         */
        const STRATEGIES = [
            { 
                id: 'stabilize', 
                name: 'üõ°Ô∏è Stabilize Survival', 
                desc: 'Focus on maintaining current status and minimizing risk',
                effect: { health: 12, food: 10, shelter: 12, morale: 8, rescue: -20 }
            },
            { 
                id: 'rescue', 
                name: 'üöÅ Pursue Rescue', 
                desc: 'Prioritize signaling and rescue attempts',
                effect: { rescue: 25, food: -20, shelter: -15, health: -10, morale: -5 }
            },
            { 
                id: 'sustainability', 
                name: 'üå± Long-term Sustainability', 
                desc: 'Build infrastructure for extended survival',
                effect: { food: 18, shelter: 12, health: 8, rescue: -25, morale: -15 }
            }
        ];

        /**
         * Scenarios with HARDER success conditions and WORSE failures
         */
        const SCENARIOS = [
            { 
                id: 'passing_aircraft', 
                name: '‚úàÔ∏è Passing Aircraft Spotted', 
                desc: 'An aircraft is spotted in the distance. This is your chance for rescue!',
                successCondition: (team) => team.status.rescue > 70 && (team.roles.includes('navigator') || team.roles.includes('celebrity')),
                successEffect: { rescue: 30, morale: 15 },
                failureEffect: { morale: -20, health: -10 },
                successMsg: 'Your team successfully signals the aircraft! Rescue is imminent.',
                failureMsg: 'The aircraft passes without noticing. Team is demoralized and exhausted from the failed attempt.'
            },
            { 
                id: 'radio_signal', 
                name: 'üìª Radio Signal Window', 
                desc: 'A brief radio transmission window opens. Can you establish contact?',
                successCondition: (team) => team.roles.includes('communicator') && team.status.rescue > 60,
                successEffect: { rescue: 25, morale: 10 },
                failureEffect: { rescue: -15, morale: -10, health: -5 },
                successMsg: 'Contact established! Your coordinates have been transmitted.',
                failureMsg: 'Unable to establish clear communication. Critical energy and resources wasted.'
            },
            { 
                id: 'internal_conflict', 
                name: '‚ö° Internal Team Conflict', 
                desc: 'Tensions rise within the team. Leadership is needed to maintain cohesion.',
                successCondition: (team) => (team.roles.includes('communicator') || team.roles.includes('strategist')) && team.status.morale > 65,
                successEffect: { morale: 12, health: 5 },
                failureEffect: { morale: -25, health: -15, food: -15, shelter: -15 },
                successMsg: 'Conflict resolved through effective communication and leadership.',
                failureMsg: 'Conflict escalates dramatically. Team effectiveness severely compromised across all areas.'
            },
            { 
                id: 'environmental_degradation', 
                name: 'üåç Environmental Degradation', 
                desc: 'Local resources are depleting faster than expected. Adaptation required.',
                successCondition: (team) => team.status.food > 75 && team.roles.includes('forager') && (team.resources.includes('seeds') || team.resources.includes('handbook')),
                successEffect: { food: 12, shelter: 8 },
                failureEffect: { food: -25, health: -20, morale: -15, shelter: -10 },
                successMsg: 'Your team successfully adapts to changing conditions.',
                failureMsg: 'Resource depletion accelerates dramatically. Survival fundamentals are threatened.'
            },
            { 
                id: 'severe_weather', 
                name: 'üåÄ Severe Weather Event', 
                desc: 'Another major weather system threatens the island. Your shelter is at risk.',
                successCondition: (team) => team.status.shelter > 70 && (team.roles.includes('builder') || team.roles.includes('engineer')),
                successEffect: { shelter: 10, health: 5 },
                failureEffect: { shelter: -30, health: -20, morale: -15, food: -10 },
                successMsg: 'Your reinforced shelter withstands the storm.',
                failureMsg: 'Shelter is severely damaged. Team exposed to elements with supplies compromised.'
            },
            { 
                id: 'medical_crisis', 
                name: 'üöë Medical Crisis', 
                desc: 'Multiple team members fall ill. Medical expertise is critical.',
                successCondition: (team) => team.roles.includes('medic') && team.status.health > 65 && team.resources.includes('water_purifier'),
                successEffect: { health: 15, morale: 5 },
                failureEffect: { health: -30, morale: -20, food: -15 },
                successMsg: 'Medical intervention prevents the crisis from escalating.',
                failureMsg: 'Illness spreads. Team capacity severely diminished.'
            }
        ];

        // ==================== GAME STATE MANAGEMENT ====================
        
        /**
         * Current team state
         */
        let currentTeam = {
            name: '',
            roles: [],
            resources: [],
            strategies: [], // Array to store strategy choices for rounds 2, 3, 4
            event: null,
            scenarios: [], // Array to store scenarios for rounds 2, 3, 4
            outcomes: [], // Array to store success/failure for each scenario
            status: {
                health: 80,
                morale: 70,
                food: 60,
                shelter: 50,
                rescue: 30
            },
            currentRound: 0, // 0 = lobby/waiting, 1-4 = active rounds, 5 = complete
            gameStarted: false
        };

        /**
         * All teams data for facilitator dashboard
         */
        let allTeams = JSON.parse(localStorage.getItem('desertIslandTeams') || '[]');
        
        /**
         * Game session control
         */
        let gameSession = JSON.parse(localStorage.getItem('desertIslandSession') || '{"started": false, "timestamp": null}');

        // ==================== INITIALIZATION ====================

        /**
         * Initialize the role selection grid
         */
        function initRoleGrid() {
            const grid = document.getElementById('roleGrid');
            grid.innerHTML = '';
            ROLES.forEach(role => {
                const item = document.createElement('div');
                item.className = 'selection-item';
                item.dataset.id = role.id;
                item.innerHTML = `
                    <div class="item-icon">${role.icon}</div>
                    <div class="item-name">${role.name}</div>
                    <div class="item-desc">${role.desc}</div>
                `;
                item.onclick = () => toggleSelection('role', role.id, 4);
                grid.appendChild(item);
            });
        }

        /**
         * Initialize the resource selection grid
         */
        function initResourceGrid() {
            const grid = document.getElementById('resourceGrid');
            grid.innerHTML = '';
            RESOURCES.forEach(resource => {
                const item = document.createElement('div');
                item.className = 'selection-item';
                item.dataset.id = resource.id;
                item.innerHTML = `
                    <div class="item-icon">${resource.icon}</div>
                    <div class="item-name">${resource.name}</div>
                    <div class="item-desc">${resource.desc}</div>
                `;
                item.onclick = () => toggleSelection('resource', resource.id, 4);
                grid.appendChild(item);
            });
        }

        /**
         * Initialize strategy grid for a specific round
         */
        function initStrategyGrid(round) {
            const gridId = `round${round}StrategyGrid`;
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            
            STRATEGIES.forEach(strategy => {
                const item = document.createElement('div');
                item.className = 'strategy-item';
                item.dataset.id = strategy.id;
                item.innerHTML = `
                    <div class="strategy-name">${strategy.name}</div>
                    <div class="strategy-desc">${strategy.desc}</div>
                `;
                item.onclick = () => selectStrategy(round, strategy.id);
                grid.appendChild(item);
            });
        }

        // ==================== GAME FLOW FUNCTIONS ====================

        /**
         * Start the game with team name entry - adds team to lobby
         */
        function startGame() {
            const teamName = document.getElementById('teamNameInput').value.trim();
            if (!teamName) {
                alert('Please enter a team name');
                return;
            }
            
            currentTeam = {
                name: teamName,
                roles: [],
                resources: [],
                strategies: [],
                event: null,
                scenarios: [],
                outcomes: [],
                status: { health: 80, morale: 70, food: 60, shelter: 50, rescue: 30 },
                currentRound: 0, // 0 = waiting in lobby
                gameStarted: false
            };
            
            // Add team to lobby
            addTeamToLobby();
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.remove('hidden');
            
            // Start polling for game start
            startGamePolling();
        }
        
        /**
         * Add team to lobby
         */
        function addTeamToLobby() {
            // Remove any existing entry for this team
            allTeams = allTeams.filter(t => t.name !== currentTeam.name);
            
            // Add current team
            allTeams.push(JSON.parse(JSON.stringify(currentTeam)));
            
            // Save to localStorage
            localStorage.setItem('desertIslandTeams', JSON.stringify(allTeams));
        }
        
        /**
         * Poll for game start from facilitator
         */
        function startGamePolling() {
            const pollInterval = setInterval(() => {
                gameSession = JSON.parse(localStorage.getItem('desertIslandSession') || '{"started": false, "timestamp": null}');
                
                if (gameSession.started && !currentTeam.gameStarted) {
                    currentTeam.gameStarted = true;
                    currentTeam.currentRound = 1;
                    clearInterval(pollInterval);
                    
                    // Hide lobby, show role selection
                    document.getElementById('lobbyScreen').classList.add('hidden');
                    document.getElementById('roleSelection').classList.remove('hidden');
                    initRoleGrid();
                }
            }, 1000); // Check every second
        }

        /**
         * Toggle selection of roles or resources
         */
        function toggleSelection(type, id, maxCount) {
            const array = type === 'role' ? currentTeam.roles : currentTeam.resources;
            const index = array.indexOf(id);
            
            if (index > -1) {
                array.splice(index, 1);
            } else {
                if (array.length >= maxCount) {
                    alert(`You can only select ${maxCount} ${type}s`);
                    return;
                }
                array.push(id);
            }
            
            updateSelectionUI(type, maxCount);
        }

        /**
         * Update the selection UI
         */
        function updateSelectionUI(type, maxCount) {
            const array = type === 'role' ? currentTeam.roles : currentTeam.resources;
            const countId = type === 'role' ? 'roleCount' : 'resourceCount';
            const btnId = type === 'role' ? 'roleBtn' : 'resourceBtn';
            const gridId = type === 'role' ? 'roleGrid' : 'resourceGrid';
            
            document.getElementById(countId).textContent = array.length;
            document.getElementById(btnId).disabled = array.length !== maxCount;
            
            const items = document.querySelectorAll(`#${gridId} .selection-item`);
            items.forEach(item => {
                if (array.includes(item.dataset.id)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        /**
         * Complete role selection
         */
        function completeRoleSelection() {
            if (currentTeam.roles.length !== 4) return;
            
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('resourceSelection').classList.remove('hidden');
            initResourceGrid();
            saveTeamToDatabase(); // Save progress
        }

        /**
         * Complete resource selection and trigger Round 1 event
         */
        function completeResourceSelection() {
            if (currentTeam.resources.length !== 4) return;
            
            // Apply bonuses from roles and resources
            applyBonuses();
            
            // Select random event
            currentTeam.event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            
            // Apply event impact
            applyEventImpact();
            
            document.getElementById('resourceSelection').classList.add('hidden');
            document.getElementById('eventScreen').classList.remove('hidden');
            
            displayEvent();
            saveTeamToDatabase(); // Save progress
        }

        /**
         * Apply initial bonuses from roles and resources
         */
        function applyBonuses() {
            currentTeam.roles.forEach(roleId => {
                const role = ROLES.find(r => r.id === roleId);
                if (role.bonus) {
                    Object.keys(role.bonus).forEach(key => {
                        currentTeam.status[key] = Math.min(100, currentTeam.status[key] + role.bonus[key]);
                    });
                }
            });
            
            currentTeam.resources.forEach(resId => {
                const resource = RESOURCES.find(r => r.id === resId);
                if (resource.bonus) {
                    Object.keys(resource.bonus).forEach(key => {
                        currentTeam.status[key] = Math.min(100, currentTeam.status[key] + resource.bonus[key]);
                    });
                }
            });
        }

        /**
         * Apply event impact with mitigation
         */
        function applyEventImpact() {
            const event = currentTeam.event;
            const mitigationFactor = calculateMitigation(event.id);
            
            Object.keys(event.impact).forEach(key => {
                const baseImpact = event.impact[key];
                const mitigatedImpact = Math.floor(baseImpact * (1 - mitigationFactor));
                currentTeam.status[key] = Math.max(0, Math.min(100, currentTeam.status[key] + mitigatedImpact));
            });
        }

        /**
         * Calculate mitigation factor - REDUCED EFFECTIVENESS
         * Returns value between 0 and 0.5 (max 50% mitigation instead of 70%)
         */
        function calculateMitigation(eventId) {
            let mitigation = 0;
            
            currentTeam.roles.forEach(roleId => {
                const role = ROLES.find(r => r.id === roleId);
                if (role.mitigates.includes(eventId)) {
                    mitigation += 0.25; // Reduced from 0.35 to 0.25
                }
            });
            
            currentTeam.resources.forEach(resId => {
                const resource = RESOURCES.find(r => r.id === resId);
                if (resource.mitigates.includes(eventId)) {
                    mitigation += 0.20; // Reduced from 0.25 to 0.20
                }
            });
            
            return Math.min(0.5, mitigation); // Cap at 50% instead of 70%
        }

        /**
         * Display Round 1 event
         */
        function displayEvent() {
            const event = currentTeam.event;
            const content = document.getElementById('eventContent');
            content.innerHTML = `
                <div class="event-title">${event.name}</div>
                <p>${event.desc}</p>
                <p style="margin-top: 10px; font-size: 13px;">Your roles and resources have helped mitigate some impacts, but challenges remain.</p>
            `;
            
            displayStatus('round1Status');
        }

        /**
         * Show specific round screen
         */
        function showRound(round) {
            // Hide all screens
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            
            currentTeam.currentRound = round;
            
            if (round >= 2 && round <= 4) {
                document.getElementById(`round${round}Screen`).classList.remove('hidden');
                initStrategyGrid(round);
            }
            
            saveTeamToDatabase(); // Save progress
        }

        /**
         * Select strategy for a round
         */
        function selectStrategy(round, strategyId) {
            const gridId = `round${round}StrategyGrid`;
            const items = document.querySelectorAll(`#${gridId} .strategy-item`);
            
            items.forEach(item => {
                if (item.dataset.id === strategyId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Store strategy temporarily
            currentTeam.strategies[round - 2] = strategyId;
            document.getElementById(`round${round}Btn`).disabled = false;
        }

        /**
         * Complete a round (2, 3, or 4)
         * Rescue scenarios only available in rounds 3 and 4
         */
        function completeRound(round) {
            const strategyId = currentTeam.strategies[round - 2];
            if (!strategyId) return;
            
            // Apply strategy effects
            const strategy = STRATEGIES.find(s => s.id === strategyId);
            Object.keys(strategy.effect).forEach(key => {
                currentTeam.status[key] = Math.max(0, Math.min(100, currentTeam.status[key] + strategy.effect[key]));
            });
            
            // Filter scenarios based on round - NO RESCUE in Round 2
            let availableScenarios = SCENARIOS;
            if (round === 2) {
                // Round 2: Only survival challenges, no rescue opportunities
                availableScenarios = SCENARIOS.filter(s => 
                    s.id !== 'passing_aircraft' && s.id !== 'radio_signal'
                );
            }
            // Rounds 3 and 4: All scenarios including rescue are available
            
            // Select random scenario from available pool
            const scenario = availableScenarios[Math.floor(Math.random() * availableScenarios.length)];
            currentTeam.scenarios[round - 2] = scenario;
            
            // Apply scenario outcome
            const success = scenario.successCondition(currentTeam);
            currentTeam.outcomes[round - 2] = success ? 'success' : 'failure';
            
            const effect = success ? scenario.successEffect : scenario.failureEffect;
            Object.keys(effect).forEach(key => {
                currentTeam.status[key] = Math.max(0, Math.min(100, currentTeam.status[key] + effect[key]));
            });
            
            // Display outcome
            document.getElementById(`round${round}Screen`).classList.add('hidden');
            document.getElementById(`round${round}Outcome`).classList.remove('hidden');
            
            displayScenario(round);
            saveTeamToDatabase(); // Save progress
        }

        /**
         * Display scenario outcome for a round
         */
        function displayScenario(round) {
            const scenario = currentTeam.scenarios[round - 2];
            const success = currentTeam.outcomes[round - 2] === 'success';
            const content = document.getElementById(`round${round}Content`);
            
            content.className = success ? 'event-box success' : 'event-box danger';
            content.innerHTML = `
                <div class="event-title">${scenario.name}</div>
                <p>${scenario.desc}</p>
                <p style="margin-top: 15px; font-weight: 600;">${success ? scenario.successMsg : scenario.failureMsg}</p>
            `;
            
            displayStatus(`round${round}Status`);
        }

        /**
         * Display status bars
         */
        function displayStatus(containerId) {
            const container = document.getElementById(containerId);
            const statusLabels = {
                health: '‚ù§Ô∏è Health',
                morale: 'üòä Morale',
                food: 'üçé Food',
                shelter: 'üè† Shelter',
                rescue: 'üöÅ Rescue'
            };
            
            let html = '';
            Object.keys(currentTeam.status).forEach(key => {
                const value = currentTeam.status[key];
                html += `
                    <div class="status-item">
                        <div class="status-label">
                            <span>${statusLabels[key]}</span>
                            <span>${value}%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill status-${key}" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        /**
         * Show final results
         */
        function showFinalResults() {
            document.getElementById('round4Outcome').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            currentTeam.currentRound = 5; // Mark as complete
            
            const explanation = generateOutcomeExplanation();
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = explanation;
            
            displayStatus('resultsStatus');
            
            saveTeamToDatabase();
            updateDashboard();
        }

        /**
         * Determine team outcome based on final status
         * Returns outcome object with category, message, and score
         */
        function determineOutcome(status) {
            // Validate status object
            if (!status || typeof status !== 'object') {
                return {
                    category: '‚ùì INCOMPLETE DATA',
                    message: 'Team data incomplete',
                    emoji: '‚ùì',
                    score: 0,
                    rank: 7
                };
            }
            
            const s = status;
            const avgSurvival = (s.health + s.food + s.shelter) / 3;
            
            // DEATH OUTCOMES CHECK FIRST (worst outcomes)
            if (s.health <= 15) {
                return {
                    category: 'üíÄ TEAM PERISHED',
                    message: 'Your team succumbed to illness and injury. The island claimed its victims.',
                    emoji: 'üíÄ',
                    score: 0,
                    rank: 7
                };
            }
            if (s.food <= 15) {
                return {
                    category: 'ü™¶ TEAM STARVED',
                    message: 'Without adequate food, your team slowly starved. A tragic end on a remote island.',
                    emoji: 'ü™¶',
                    score: 5,
                    rank: 6
                };
            }
            
            // BREAKDOWN OUTCOMES
            if (s.morale <= 20) {
                return {
                    category: 'üíî TEAM FRACTURED',
                    message: 'Internal conflict tore the team apart. Members went their separate ways on the island.',
                    emoji: 'üíî',
                    score: 10,
                    rank: 5
                };
            }
            
            // RESCUE OUTCOMES (require HIGH rescue AND decent survival stats)
            if (s.rescue >= 85 && avgSurvival >= 35) {
                return {
                    category: 'üöÅ SUCCESSFULLY RESCUED!',
                    message: 'Your team was successfully evacuated! You\'re heading home.',
                    emoji: 'üöÅ',
                    score: 100 + avgSurvival,
                    rank: 1
                };
            }
            if (s.rescue >= 70 && avgSurvival >= 35) {
                return {
                    category: 'üì° RESCUE IMMINENT',
                    message: 'Contact established with rescue teams. Evacuation expected within days.',
                    emoji: 'üì°',
                    score: 80 + avgSurvival,
                    rank: 2
                };
            }
            
            // SURVIVAL OUTCOMES
            if (avgSurvival >= 60 && s.morale >= 50) {
                return {
                    category: 'üèùÔ∏è ISLAND HOMESTEADERS',
                    message: 'Your team has built a sustainable life on the island. Rescue hopes fade, but you\'re thriving.',
                    emoji: 'üèùÔ∏è',
                    score: 60 + avgSurvival + s.morale,
                    rank: 3
                };
            }
            if (avgSurvival >= 40) {
                return {
                    category: '‚ö†Ô∏è BARELY SURVIVING',
                    message: 'Your team clings to survival. Each day is a struggle with uncertain prospects.',
                    emoji: '‚ö†Ô∏è',
                    score: 30 + avgSurvival,
                    rank: 4
                };
            }
            
            // DEFAULT - DIRE SITUATION
            return {
                category: '‚ò†Ô∏è DESPERATE SITUATION',
                message: 'Your team faces imminent collapse. Multiple critical failures threaten survival.',
                emoji: '‚ò†Ô∏è',
                score: 15,
                rank: 6
            };
        }

        /**
         * Determine which team(s) won
         * Returns array of winners (can be multiple if tied)
         */
        function determineWinners() {
            try {
                const completeTeams = allTeams.filter(t => t.currentRound === 5);
                if (completeTeams.length === 0) return [];
                
                let highestScore = -1;
                let winners = [];
                
                completeTeams.forEach(team => {
                    if (team && team.status) {
                        const outcome = determineOutcome(team.status);
                        if (outcome.score > highestScore) {
                            highestScore = outcome.score;
                            winners = [team];
                        } else if (outcome.score === highestScore) {
                            winners.push(team);
                        }
                    }
                });
                
                return winners;
            } catch (error) {
                console.error('Error determining winners:', error);
                return [];
            }
        }

        /**
         * Generate outcome explanation with clear result
         */
        function generateOutcomeExplanation() {
            const s = currentTeam.status;
            const outcome = determineOutcome(s);
            
            let explanation = `
                <div style="background: ${outcome.rank <= 2 ? '#d4edda' : outcome.rank <= 4 ? '#fff3cd' : '#f8d7da'}; 
                            border: 3px solid ${outcome.rank <= 2 ? '#28a745' : outcome.rank <= 4 ? '#ffc107' : '#dc3545'}; 
                            padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${outcome.emoji}</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px; color: #2c3e50;">
                        ${outcome.category}
                    </div>
                    <div style="font-size: 16px; color: #495057;">
                        ${outcome.message}
                    </div>
                </div>
            `;
            
            explanation += '<p style="margin-top: 20px;"><strong>üìä Final Status Summary:</strong></p><p>';
            
            // Status breakdown
            if (s.health <= 25) {
                explanation += '‚ù§Ô∏è <strong>Health: Critical</strong> - Team members are severely weakened. ';
            } else if (s.health <= 50) {
                explanation += '‚ù§Ô∏è <strong>Health: Poor</strong> - Injuries and illness taking their toll. ';
            } else if (s.health >= 70) {
                explanation += '‚ù§Ô∏è <strong>Health: Good</strong> - Team maintained physical wellbeing. ';
            } else {
                explanation += '‚ù§Ô∏è <strong>Health: Fair</strong> - Managing but strained. ';
            }
            
            if (s.food <= 25) {
                explanation += 'üçé <strong>Food: Starving</strong> - Rations nearly depleted. ';
            } else if (s.food <= 50) {
                explanation += 'üçé <strong>Food: Scarce</strong> - Food security uncertain. ';
            } else if (s.food >= 70) {
                explanation += 'üçé <strong>Food: Abundant</strong> - Sustainable food sources established. ';
            } else {
                explanation += 'üçé <strong>Food: Adequate</strong> - Basic needs met. ';
            }
            
            if (s.shelter <= 25) {
                explanation += 'üè† <strong>Shelter: Failing</strong> - Exposed to elements. ';
            } else if (s.shelter <= 50) {
                explanation += 'üè† <strong>Shelter: Basic</strong> - Minimal protection. ';
            } else if (s.shelter >= 70) {
                explanation += 'üè† <strong>Shelter: Strong</strong> - Well-protected from weather. ';
            } else {
                explanation += 'üè† <strong>Shelter: Functional</strong> - Adequate protection. ';
            }
            
            if (s.morale <= 25) {
                explanation += 'üòî <strong>Morale: Collapsed</strong> - Team unity broken. ';
            } else if (s.morale <= 50) {
                explanation += 'üòê <strong>Morale: Low</strong> - Tensions high, cohesion strained. ';
            } else if (s.morale >= 70) {
                explanation += 'üòä <strong>Morale: High</strong> - Team spirit strong. ';
            } else {
                explanation += 'üòê <strong>Morale: Fair</strong> - Team holding together. ';
            }
            
            if (s.rescue <= 25) {
                explanation += 'üöÅ <strong>Rescue: Remote</strong> - No realistic prospect of rescue. ';
            } else if (s.rescue <= 50) {
                explanation += 'üì° <strong>Rescue: Uncertain</strong> - Limited communication established. ';
            } else if (s.rescue >= 80) {
                explanation += 'üöÅ <strong>Rescue: Confirmed</strong> - Evacuation secured! ';
            } else {
                explanation += 'üì° <strong>Rescue: Possible</strong> - Rescue teams aware of location. ';
            }
            
            explanation += '</p><p style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;"><strong>üéØ Key Factors:</strong> ';
            
            // Strategy assessment
            explanation += `Your strategic choices (${currentTeam.strategies.map(s => STRATEGIES.find(st => st.id === s).name.replace(/[üõ°Ô∏èüöÅüå±]/g, '')).join(', ')}) `;
            
            const successCount = currentTeam.outcomes.filter(o => o === 'success').length;
            if (successCount === 3) {
                explanation += 'aligned perfectly with all scenarios. ';
            } else if (successCount >= 2) {
                explanation += 'worked well for most scenarios. ';
            } else if (successCount === 1) {
                explanation += 'had mixed results with the scenarios encountered. ';
            } else {
                explanation += 'failed to address the challenges faced. ';
            }
            
            // Role effectiveness
            const roleNames = currentTeam.roles.map(id => ROLES.find(r => r.id === id).name).join(', ');
            explanation += `Your team composition (${roleNames}) `;
            
            const mitigationFactor = calculateMitigation(currentTeam.event.id);
            if (mitigationFactor >= 0.4) {
                explanation += 'effectively mitigated the initial crisis. ';
            } else if (mitigationFactor >= 0.2) {
                explanation += 'provided some protection against the initial crisis. ';
            } else {
                explanation += 'struggled against the initial crisis. ';
            }
            
            explanation += '</p>';
            
            return explanation;
        }

        /**
         * Save team to database
         */
        function saveTeamToDatabase() {
            allTeams = allTeams.filter(t => t.name !== currentTeam.name);
            allTeams.push(JSON.parse(JSON.stringify(currentTeam)));
            localStorage.setItem('desertIslandTeams', JSON.stringify(allTeams));
        }

        /**
         * Reset game
         */
        function resetGame() {
            currentTeam = {
                name: '',
                roles: [],
                resources: [],
                strategies: [],
                event: null,
                scenarios: [],
                outcomes: [],
                status: { health: 80, morale: 70, food: 60, shelter: 50, rescue: 30 },
                currentRound: 1
            };
            
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('teamNameInput').value = '';
        }

        // ==================== FACILITATOR DASHBOARD ====================

        /**
         * Show dashboard
         */
        function showDashboard() {
            document.getElementById('teamPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            updateDashboard();
        }

        /**
         * Hide dashboard
         */
        function hideDashboard() {
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('teamPage').classList.remove('hidden');
        }

        /**
         * Clear all team data from localStorage
         */
        function clearAllData() {
            if (confirm('Are you sure you want to clear all team data? This cannot be undone.')) {
                localStorage.removeItem('desertIslandTeams');
                localStorage.removeItem('desertIslandSession');
                allTeams = [];
                gameSession = {started: false, timestamp: null};
                updateDashboard();
                alert('All team data has been cleared.');
            }
        }

        /**
         * Start all teams simultaneously
         */
        function startAllTeams() {
            if (allTeams.filter(t => t.currentRound === 0).length === 0) {
                alert('No teams in lobby to start.');
                return;
            }
            
            if (confirm('Start the game for all teams in the lobby?')) {
                gameSession = {
                    started: true,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('desertIslandSession', JSON.stringify(gameSession));
                updateDashboard();
                alert('Game started! All teams can now begin.');
            }
        }

        /**
         * Update dashboard
         */
        function updateDashboard() {
            try {
                allTeams = JSON.parse(localStorage.getItem('desertIslandTeams') || '[]');
                gameSession = JSON.parse(localStorage.getItem('desertIslandSession') || '{"started": false, "timestamp": null}');
                
                const container = document.getElementById('teamsDisplay');
                
                // Update session status
                const lobbyTeams = allTeams.filter(t => t.currentRound === 0);
                const activeTeams = allTeams.filter(t => t.currentRound >= 1 && t.currentRound <= 4);
                const completeTeams = allTeams.filter(t => t.currentRound === 5);
                
                const sessionStatus = document.getElementById('sessionStatus');
                const startBtn = document.getElementById('startAllBtn');
                const lobbyCountSpan = document.getElementById('lobbyCount');
                
                if (gameSession.started) {
                    sessionStatus.style.background = '#d4edda';
                    sessionStatus.innerHTML = `‚úÖ Game Started - Active: ${activeTeams.length} | Complete: ${completeTeams.length}`;
                    startBtn.disabled = true;
                    startBtn.style.opacity = '0.5';
                } else {
                    sessionStatus.style.background = '#fff3cd';
                    lobbyCountSpan.textContent = lobbyTeams.length;
                    startBtn.disabled = false;
                    startBtn.style.opacity = '1';
                }
                
                if (allTeams.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 40px;">No teams have joined yet.</p>';
                    return;
                }
                
                let html = '';
                
                // Determine winners (can be multiple if tied)
                const winners = determineWinners();
                const winnerNames = winners.map(w => w.name);
                
                // Show winner banner if at least 2 teams complete
                if (completeTeams.length >= 2 && winners.length > 0) {
                    if (winners.length === 1) {
                        // Single winner
                        const winner = winners[0];
                        const winnerOutcome = determineOutcome(winner.status);
                        html += `
                            <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); 
                                        border: 3px solid #f0c000; border-radius: 12px; padding: 30px; text-align: center; 
                                        margin-bottom: 30px; box-shadow: 0 8px 20px rgba(255,215,0,0.3);">
                                <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
                                <div style="font-size: 32px; font-weight: 700; color: #2c3e50; margin-bottom: 10px;">
                                    WINNING TEAM
                                </div>
                                <div style="font-size: 28px; font-weight: 600; color: #495057; margin-bottom: 15px;">
                                    ${winner.name}
                                </div>
                                <div style="font-size: 20px; color: #6c757d;">
                                    ${winnerOutcome.category}
                                </div>
                                <div style="font-size: 16px; color: #6c757d; margin-top: 10px;">
                                    Score: ${Math.round(winnerOutcome.score)}
                                </div>
                            </div>
                        `;
                    } else {
                        // Multiple winners (tie)
                        html += `
                            <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); 
                                        border: 3px solid #f0c000; border-radius: 12px; padding: 30px; text-align: center; 
                                        margin-bottom: 30px; box-shadow: 0 8px 20px rgba(255,215,0,0.3);">
                                <div style="font-size: 60px; margin-bottom: 10px;">üèÜüèÜ</div>
                                <div style="font-size: 32px; font-weight: 700; color: #2c3e50; margin-bottom: 10px;">
                                    TIE - ${winners.length} WINNING TEAMS!
                                </div>
                                <div style="font-size: 24px; font-weight: 600; color: #495057; margin-bottom: 15px;">
                                    ${winners.map(w => w.name).join(' ‚Ä¢ ')}
                                </div>
                                <div style="font-size: 16px; color: #6c757d;">
                                    Tied Score: ${Math.round(determineOutcome(winners[0].status).score)}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Sort teams: lobby first, then by round, then complete
                const sortedTeams = [...allTeams].sort((a, b) => {
                    if (a.currentRound === 0 && b.currentRound !== 0) return -1;
                    if (a.currentRound !== 0 && b.currentRound === 0) return 1;
                    if (a.currentRound === 5 && b.currentRound !== 5) return 1;
                    if (a.currentRound !== 5 && b.currentRound === 5) return -1;
                    return a.currentRound - b.currentRound;
                });
                
                sortedTeams.forEach(team => {
                    const isWinner = winnerNames.includes(team.name) && team.currentRound === 5;
                    html += generateTeamCard(team, isWinner);
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Dashboard update error:', error);
                const container = document.getElementById('teamsDisplay');
                container.innerHTML = '<p style="text-align: center; color: #dc3545; margin-top: 40px;">Error loading team data. <button onclick="clearAllData()" class="btn">Clear Data and Restart</button></p>';
            }
        }

        /**
         * Generate team card for dashboard
         */
        function generateTeamCard(team, isWinner = false) {
            // Validate team data
            if (!team || !team.status) {
                return `
                    <div class="team-card">
                        <div class="team-header">
                            <div class="team-name">üèùÔ∏è ${team?.name || 'Unknown Team'}</div>
                            <div class="team-status complete">Incomplete</div>
                        </div>
                        <p style="color: #dc3545;">This team's data is incomplete. Please restart the simulation.</p>
                    </div>
                `;
            }
            
            // Determine status badge
            let statusBadge = '';
            let statusClass = '';
            if (team.currentRound === 0) {
                statusBadge = '‚è≥ Waiting';
                statusClass = 'waiting';
            } else if (team.currentRound >= 1 && team.currentRound <= 4) {
                statusBadge = `üéÆ Round ${team.currentRound}`;
                statusClass = 'playing';
            } else if (team.currentRound === 5) {
                statusBadge = '‚úÖ Complete';
                statusClass = 'complete';
            }
            
            const statusLabels = { health: '‚ù§Ô∏è Health', morale: 'üòä Morale', food: 'üçé Food', shelter: 'üè† Shelter', rescue: 'üöÅ Rescue' };
            
            let statusBars = '';
            Object.keys(team.status).forEach(key => {
                const value = team.status[key];
                statusBars += `
                    <div class="status-item">
                        <div class="status-label">
                            <span style="font-size: 12px;">${statusLabels[key]}</span>
                            <span style="font-size: 12px;">${value}</span>
                        </div>
                        <div class="status-bar" style="height: 18px;">
                            <div class="status-bar-fill status-${key}" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            });
            
            let cardContent = '';
            
            // For teams in lobby or in progress
            if (team.currentRound < 5) {
                cardContent = `
                    <div class="team-card" style="padding-top: 20px;">
                        
                        <div class="team-header">
                            <div class="team-name">üèùÔ∏è ${team.name}</div>
                            <div class="team-status ${statusClass}">${statusBadge}</div>
                        </div>
                        
                        ${statusBars}
                `;
                
                if (team.currentRound > 0 && team.roles && team.resources) {
                    const roleNames = team.roles.map(id => ROLES.find(r => r.id === id)?.name || id).join(', ');
                    const resourceNames = team.resources.map(id => RESOURCES.find(r => r.id === id)?.name || id).join(', ');
                    
                    cardContent += `
                        <div class="team-choices" style="margin-top: 15px;">
                            <strong>Roles:</strong> ${roleNames}<br>
                            <strong>Resources:</strong> ${resourceNames}
                        </div>
                    `;
                }
                
                cardContent += `</div>`;
            } 
            // For completed teams
            else {
                const outcome = determineOutcome(team.status);
                const roleNames = team.roles.map(id => ROLES.find(r => r.id === id)?.name || id).join(', ');
                const resourceNames = team.resources.map(id => RESOURCES.find(r => r.id === id)?.name || id).join(', ');
                
                cardContent = `
                    <div class="team-card" style="${isWinner ? 'border: 4px solid #ffd700; box-shadow: 0 12px 30px rgba(255,215,0,0.5);' : ''}">
                        ${isWinner ? '<div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #ffd700; padding: 8px 20px; border-radius: 20px; font-size: 16px; font-weight: 700; color: #2c3e50; box-shadow: 0 4px 12px rgba(255,215,0,0.4);">üèÜ WINNER üèÜ</div>' : ''}
                        
                        <div class="team-header" style="margin-top: ${isWinner ? '10px' : '0'};">
                            <div class="team-name">üèùÔ∏è ${team.name}</div>
                            <div class="team-status ${statusClass}">${statusBadge}</div>
                        </div>
                        
                        <div style="background: ${outcome.rank <= 2 ? '#d4edda' : outcome.rank <= 4 ? '#fff3cd' : '#f8d7da'}; 
                                    padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 5px;">${outcome.emoji}</div>
                            <div style="font-size: 16px; font-weight: 700; color: #2c3e50;">
                                ${outcome.category}
                            </div>
                            <div style="font-size: 13px; color: #495057; margin-top: 8px; font-weight: 600;">
                                Final Score: ${Math.round(outcome.score)}
                            </div>
                        </div>
                        
                        <div class="team-choices">
                            <strong>Roles:</strong> ${roleNames}<br>
                            <strong>Resources:</strong> ${resourceNames}<br>
                            ${team.event ? `<strong>Round 1 Event:</strong> ${team.event.name}<br>` : ''}
                            <strong>Strategies:</strong> ${team.strategies && team.strategies.length > 0 ? team.strategies.map((s, i) => `R${i+2}: ${STRATEGIES.find(st => st.id === s)?.name?.replace(/[üõ°Ô∏èüöÅüå±]/g, '') || s}`).join(' | ') : 'N/A'}
                        </div>
                        
                        ${statusBars}
                        
                        <div class="outcome-summary" style="margin-top: 15px; font-size: 12px;">
                            ${outcome.message}
                        </div>
                    </div>
                `;
            }
            
            return cardContent;
        }

        // Auto-refresh dashboard every 5 seconds
        setInterval(() => {
            if (!document.getElementById('dashboardPage').classList.contains('hidden')) {
                updateDashboard();
            }
        }, 5000);
    </script>
</body>
</html>